/**
 * Test script to verify the actual API endpoint works without timeout errors
 */

const axios = require('axios');
require('dotenv').config();

async function testActualAPI() {
  console.log('üß™ Testing Actual API Endpoint with Real Server...\n');

  try {
    const payload = {
      serviceName: 'Tooth Extractions',
      category: 'oral-surgery',
      description: 'Professional tooth extraction procedures',
      websiteId: '507f1f77bcf86cd799439011', // Mock ObjectId
      generateSEO: true,
      generateFAQ: true,
      generateProcedure: true,
      generateBenefits: true,
      generateBlogs: true,
      fastMode: false, // Force comprehensive generation
      provider: 'auto',
      temperature: 0.7,
      keywords: ['tooth extraction', 'oral surgery', 'dental removal']
    };

    console.log('üì° Testing API endpoint: POST http://localhost:5000/api/services/generate-content-from-data');
    console.log('üì¶ Payload:', JSON.stringify(payload, null, 2));
    console.log('\nüïê Starting request... (this may take 60+ seconds)');

    const startTime = Date.now();

    const response = await axios.post(
      'http://localhost:5000/api/services/generate-content-from-data',
      payload,
      {
        headers: {
          'Content-Type': 'application/json'
        },
        timeout: 120000 // 2 minutes client timeout
      }
    );

    const endTime = Date.now();
    const duration = (endTime - startTime) / 1000;

    console.log(`\n‚úÖ API REQUEST SUCCESSFUL! (took ${duration.toFixed(2)} seconds)`);
    console.log(`üìä Response status: ${response.status}`);

    // Check response structure
    const data = response.data;
    console.log('\nüîç Response Analysis:');
    console.log(`‚úì Success: ${data.success}`);
    console.log(`‚úì Message: ${data.message || 'N/A'}`);

    if (data.data) {
      console.log(`‚úì Comprehensive Content: ${data.data.comprehensiveContent ? 'Present' : 'Missing'}`);

      if (data.data.comprehensiveContent) {
        const sections = Object.keys(data.data.comprehensiveContent);
        console.log(`‚úì Sections Generated: ${sections.length}/11`);
        console.log(`  Sections: ${sections.join(', ')}`);

        // Check word counts for key sections
        const intro = data.data.comprehensiveContent.introduction;
        if (intro) {
          const wordCount = intro.split(' ').length;
          console.log(`‚úì Introduction: ${wordCount} words (target: 100)`);
        }
      }

      console.log(`‚úì LLM Content: ${data.data.llmContent ? 'Present' : 'Missing'}`);
      console.log(`‚úì Blogs: ${data.data.blogs ? `${data.data.blogs.length} generated` : 'Missing'}`);

      if (data.contentStats) {
        console.log(`‚úì Content Stats: ${JSON.stringify(data.contentStats, null, 2)}`);
      }
    }

    console.log('\nüéâ SUCCESS: API endpoint works without timeout errors!');
    console.log('‚úÖ All 11-section content generation is functioning');
    console.log('‚úÖ Retry logic and timeout handling working correctly');
    console.log('‚úÖ No fallback content - all sections generated by LLM');

  } catch (error) {
    console.error('\n‚ùå API Request Failed:');
    console.error(`   Error: ${error.message}`);

    if (error.code === 'ECONNABORTED') {
      console.error('   Cause: Request timeout (client-side)');
    } else if (error.response) {
      console.error(`   Status: ${error.response.status}`);
      console.error(`   Response: ${JSON.stringify(error.response.data, null, 2)}`);
    } else if (error.code === 'ECONNREFUSED') {
      console.error('   Cause: Server not running or connection refused');
    }

    console.log('\nÔøΩÔøΩ If this is a timeout error, it indicates:');
    console.log('   - LLM providers may be experiencing high load');
    console.log('   - Network connectivity issues');
    console.log('   - Rate limiting from Google AI API');
    console.log('   - This is normal behavior - the system fails fast without fallbacks');
  }
}

testActualAPI();